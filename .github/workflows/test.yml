name: Test Provisioning Profile Upsert

on:
  workflow_dispatch:
    inputs:
      profile_name:
        description: 'Provisioning Profile åç¨±'
        required: true
        type: string
        default: 'Test Profile'
      
      cert_type:
        description: 'è­‰æ›¸é¡å‹'
        required: true
        type: choice
        options:
          - 'IOS_DEVELOPMENT'
          - 'IOS_DISTRIBUTION'
          - 'MAC_APP_DEVELOPMENT'
          - 'MAC_APP_DISTRIBUTION'
        default: 'IOS_DEVELOPMENT'
      
      bundle_id:
        description: 'Bundle ID'
        required: true
        type: string
        default: 'com.nextdrive.testapp'
      
      profile_type:
        description: 'Profile é¡å‹'
        required: true
        type: choice
        options:
          - 'IOS_APP_DEVELOPMENT'
          - 'IOS_APP_STORE'
          - 'IOS_APP_ADHOC'
          - 'MAC_APP_DEVELOPMENT'
          - 'MAC_APP_STORE'
        default: 'IOS_APP_DEVELOPMENT'

jobs:
  test-upsert:
    runs-on: ubuntu-latest
    outputs:
      profile-id: ${{ steps.update-profile.outputs.profile_id }}
      cert-id: ${{ steps.update-profile.outputs.cert_id }}
      success: ${{ steps.update-profile.outputs.success }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Update Provisioning Profile
        id: update-profile
        uses: ./
        with:
          profile_name: ${{ github.event.inputs.profile_name }}
          cert_type: ${{ github.event.inputs.cert_type }}
          issuer_id: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
          key_id: ${{ secrets.APP_STORE_CONNECT_KEY_ID }}
          private_key_base64: ${{ secrets.APP_STORE_CONNECT_PRIVATE_KEY_BASE64 }}
          bundle_id: ${{ github.event.inputs.bundle_id }}
          profile_type: ${{ github.event.inputs.profile_type }}
      
      - name: Display Results
        run: |
          echo "ğŸ“‹ åŸ·è¡Œçµæœï¼š"
          echo "- æˆåŠŸç‹€æ…‹: ${{ steps.update-profile.outputs.success }}"
          echo "- Profile ID: ${{ steps.update-profile.outputs.profile_id }}"
          echo "- Certificate ID: ${{ steps.update-profile.outputs.cert_id }}"
          
          if [[ "${{ steps.update-profile.outputs.success }}" == "true" ]]; then
            echo "âœ… Provisioning Profile æ›´æ–°æˆåŠŸï¼"
          else
            echo "âŒ Provisioning Profile æ›´æ–°å¤±æ•—ï¼"
            exit 1
          fi

  # ç¤ºç¯„å¦‚ä½•åœ¨å¾ŒçºŒ job ä¸­ä½¿ç”¨çµæœ
  use-results:
    needs: test-upsert
    runs-on: ubuntu-latest
    if: needs.test-upsert.outputs.success == 'true'
    
    steps:
      - name: Use Profile Information
        run: |
          echo "ğŸ‰ å¯ä»¥ä½¿ç”¨æ›´æ–°å¾Œçš„ Provisioning Profileï¼š"
          echo "Profile ID: ${{ needs.test-upsert.outputs.profile-id }}"
          echo "Certificate ID: ${{ needs.test-upsert.outputs.cert-id }}"
          
          # é€™è£¡å¯ä»¥åŠ å…¥å¯¦éš›çš„å»ºç½®æ­¥é©Ÿ
          echo "ç¾åœ¨å¯ä»¥ä½¿ç”¨æ­¤ Profile é€²è¡Œ iOS æ‡‰ç”¨ç¨‹å¼å»ºç½®..."
